<div class="file-upload-container">
    <span class="form-label d-block mb-2">{{ label() }}</span>

    <div ng2FileDrop [uploader]="uploader"
        class="drop-zone p-4 mb-3 border border-2 border-dashed rounded text-center bg-light"
        [class.nv-file-over]="isOverDropZone()" (fileOver)="isOverDropZone.set($event)">
        <i class="bi bi-cloud-arrow-up display-4 text-primary"></i>
        <p class="mt-2 mb-0">Glissez-déposez vos fichiers ici ou</p>
        <div class="mt-2">
            <label class="btn btn-outline-primary btn-sm">
                Parcourir
                <input type="file" ng2FileSelect [uploader]="uploader" multiple class="d-none" />
            </label>
        </div>
    </div>

    <!-- Upload Progress for Queue -->
    @if (uploader.queue.length > 0) {
    <div class="upload-queue mb-4">
        <h6 class="small text-uppercase fw-bold text-muted mb-3">File d'attente</h6>
        @for (item of uploader.queue; track item) {
        <div class="queue-item p-2 border rounded mb-2 bg-white shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="text-truncate small" style="max-width: 200px;">{{ item?.file?.name }}</span>
                <span class="badge bg-light text-dark small">{{ formatSize(item?.file?.size || 0) }}</span>
            </div>

            <div class="progress" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                    [style.width.%]="item.progress"></div>
            </div>

            <div class="d-flex justify-content-end mt-2 gap-2">
                <button type="button" class="btn btn-success btn-xs py-0 px-2" (click)="item.upload()"
                    [disabled]="item.isReady || item.isUploading || item.isSuccess">
                    <i class="bi bi-upload"></i>
                </button>
                <button type="button" class="btn btn-danger btn-xs py-0 px-2" (click)="item.remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        }

        <div class="mt-3">
            <div class="progress mb-2" style="height: 10px;">
                <div class="progress-bar" role="progressbar" [style.width.%]="uploader.progress"></div>
            </div>
            <div class="btn-group btn-group-sm w-100">
                <button type="button" class="btn btn-success" (click)="uploader.uploadAll()"
                    [disabled]="!uploader.getNotUploadedItems().length">
                    Tout envoyer
                </button>
                <button type="button" class="btn btn-warning" (click)="uploader.cancelAll()"
                    [disabled]="!uploader.isUploading">
                    Tout annuler
                </button>
                <button type="button" class="btn btn-danger" (click)="uploader.clearQueue()"
                    [disabled]="!uploader.queue.length">
                    Tout supprimer
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Display Uploaded Files (Preview) -->
    @if (uploadedFiles().length > 0) {
    <div class="uploaded-files-preview mt-4">
        <h6 class="small text-uppercase fw-bold text-muted mb-3">Fichiers téléchargés</h6>
        <div class="row g-3">
            @for (file of uploadedFiles(); track $index) {
            <div class="col-sm-6 col-md-4">
                <div class="card h-100 border-0 shadow-sm preview-card">
                    <div class="card-img-container position-relative bg-light d-flex align-items-center justify-content-center overflow-hidden"
                        style="height: 120px;">
                        @if (isImage(file.type) && file.data) {
                        <img [src]="file.data" class="img-fluid h-100 w-100 object-fit-cover" [alt]="file.name">
                        } @else {
                        <i class="bi display-1" [ngClass]="getFileIcon(file.extension)"></i>
                        }

                        <button type="button"
                            class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 rounded-circle shadow-sm"
                            (click)="removeFile($index)" title="Supprimer">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="card-body p-2">
                        <p class="card-text small text-truncate mb-0 fw-medium" [title]="file.name">
                            {{ file.name }}
                        </p>
                        <p class="text-muted extra-small mb-0">
                            {{ formatSize(file.size) }}
                        </p>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
    }
</div>